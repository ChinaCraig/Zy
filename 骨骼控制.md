# 🦴 Three-VRM 虚拟人骨骼控制系统完整说明

## 📋 系统概述

基于 **Three-VRM 0.6.11** 版本实现的虚拟人骨骼控制系统，提供聊天控制、图形面板控制、动作编排和随机生成等多种控制方式。

### ✨ 核心特性
- 🗣️ **聊天控制** - 自然语言指令控制
- 🎮 **图形面板** - 直观的点击操作界面  
- 🎬 **动作编排** - 自定义动作序列创建
- 🎲 **随机生成** - 智能随机动作生成
- 📱 **移动适配** - 完整的响应式设计

---

## 🦴 支持的骨骼类型

根据 VRM 1.0 规范，系统支持以下骨骼：

### 核心骨骼
- `hips` - 臀部 | `spine` - 脊柱 | `chest` - 胸部 | `upperChest` - 上胸部
- `neck` - 颈部 | `head` - 头部

### 头部细节
- `leftEye` - 左眼 | `rightEye` - 右眼 | `jaw` - 下颌

### 上肢骨骼
- `leftShoulder` / `rightShoulder` - 左/右肩膀
- `leftUpperArm` / `rightUpperArm` - 左/右上臂  
- `leftLowerArm` / `rightLowerArm` - 左/右前臂
- `leftHand` / `rightHand` - 左/右手

### 下肢骨骼
- `leftUpperLeg` / `rightUpperLeg` - 左/右大腿
- `leftLowerLeg` / `rightLowerLeg` - 左/右小腿
- `leftFoot` / `rightFoot` - 左/右脚
- `leftToes` / `rightToes` - 左/右脚趾

### 手指骨骼
- **拇指**: `leftThumb1-3` / `rightThumb1-3` - 左/右拇指关节
- **食指**: `leftIndex1-3` / `rightIndex1-3` - 左/右食指关节  
- **中指**: `leftMiddle1-3` / `rightMiddle1-3` - 左/右中指关节
- **无名指**: `leftRing1-3` / `rightRing1-3` - 左/右无名指关节
- **小指**: `leftLittle1-3` / `rightLittle1-3` - 左/右小指关节

---

## 🗣️ 聊天控制功能

### 头部动作指令
- `点头` / `点点头` - 头部向下点头
- `摇头` / `摇摇头` - 头部左右摇摆  
- `转头` / `看左` / `向左看` - 头部向左转动
- `看右` / `向右看` - 头部向右转动

### 手臂动作指令
- `举右臂` / `举起右臂` / `抬起右臂` - 右臂向上举起
- `举左臂` / `举起左臂` / `抬起左臂` - 左臂向上举起
- `挥手` / `挥挥手` - 举起右臂并挥动前臂

### 身体动作指令
- `鞠躬` / `弯腰` / `行礼` - 身体向前弯曲
- `重置动作` / `重置` / `复位` / `初始` - 重置所有骨骼到初始位置

### 系统指令
- `显示骨骼` / `骨骼列表` / `有哪些骨骼` - 显示所有可用骨骼

---

## 🎮 图形控制面板

### 界面布局

#### 三层固定布局设计
```
┌─────────────────────────────────────────┐
│ 🦴 骨骼控制                              │ ← 面板标题
├─────────────────────────────────────────┤
│ 🎯 固定顶部：角度控制区域                 │ ← 始终可见
│ ├ 当前选中骨骼的旋转角度 (度)             │
│ ├ X轴(俯仰) Y轴(转向) Z轴(倾斜)           │
│ └ [重置所有骨骼]                        │
├─────────────────────────────────────────┤
│ 📜 中间滚动：骨骼列表区域                 │ ← 可滚动
│ ├ 头部区域 (5)                          │
│ │  ├ 头部    [旋转] [重置]              │
│ │  ├ 颈部    [旋转] [重置]              │
│ │  └ ...                               │
│ ├ 躯干区域 (4)                          │
│ ├ 左臂区域 (4) / 右臂区域 (4)            │
│ ├ 左腿区域 (4) / 右腿区域 (4)            │
│ ├ 左手指区域 (...) / 右手指区域 (...)     │
│ └ 其他区域 (...)                        │
├─────────────────────────────────────────┤
│ 🎬 固定底部：动作编排区域                 │ ← 始终可见
│ ├ 操作说明：点击骨骼选中 → 设置角度        │
│ ├ 已选中: 头部  [➕ 添加到序列]          │
│ ├ ┌─动作序列─────────────────────────┐   │
│ │ │ 1. 头部 (X:30°, Y:0°, Z:0°) [×] │   │
│ │ │ 2. 右上臂 (X:0°, Y:0°, Z:-60°)[×]│   │
│ │ └───────────────────────────────┘   │
│ └ [🎬 执行] [🗑️ 清空序列] [重置骨骼]      │
└─────────────────────────────────────────┘
```

### 角度控制说明
- **X轴 (俯仰)**: 前后俯仰旋转 (点头/抬头动作)
- **Y轴 (转向)**: 左右转动旋转 (左右转头动作)
- **Z轴 (倾斜)**: 侧向倾斜旋转 (左右倾斜动作)
- **角度范围**: -180° 到 +180°

### 骨骼分类显示
所有骨骼名称均显示为中文，分类清晰：
- **头部**: 头部、颈部、左眼、右眼、下颌
- **躯干**: 臀部、脊柱、胸部、上胸部
- **左臂/右臂**: 肩膀、上臂、前臂、手
- **左腿/右腿**: 大腿、小腿、脚、脚趾
- **左手指/右手指**: 详细的手指关节映射（近端/中端/远端）

---

## 🎬 动作编排系统

### 操作流程
```
1️⃣ 点击骨骼选中 → 2️⃣ 设置角度 → 3️⃣ 添加到序列 → 4️⃣ 执行序列
```

### 功能特性
- **自定义组合**: 可任意组合不同骨骼的动作
- **精确控制**: 每个骨骼可设置独立的X/Y/Z轴角度
- **灵活编排**: 支持同一骨骼的多个动作
- **视觉反馈**: 选中骨骼高亮显示，执行过程实时高亮
- **序列管理**: 支持单独删除、批量执行和清空序列

### 使用示例
```
动作序列示例：
1. 头部 (X:30°, Y:0°, Z:0°)     # 点头
2. 头部 (X:0°, Y:-45°, Z:0°)    # 左转头
3. 右上臂 (X:0°, Y:0°, Z:-90°)  # 举右手
4. 左上臂 (X:0°, Y:0°, Z:90°)   # 举左手  
5. 脊柱 (X:30°, Y:0°, Z:0°)     # 鞠躬
```

---

## 🎲 随机动作生成功能

### 智能生成特性
- **数量控制**: 可设置1-20个随机动作
- **智能筛选**: 从所有可用骨骼中随机选择，避免重复
- **分层角度**: 小幅度(±30°)、中等幅度(±60°)、大幅度(±90°)
- **自动集成**: 生成的动作自动添加到编排序列中

### 界面布局
```
🎲 随机动作生成
├ 随机动作数量: [3] [🎲 生成随机动作]
└ 紫色主题设计，与其他功能区分
```

### 应用场景
- **创意设计**: 作为动作创作的灵感启发
- **娱乐互动**: 让虚拟人进行随机表演
- **系统测试**: 快速测试各种骨骼组合的表现

---

## 📱 移动端适配

### 响应式特性
- **自动检测**: 小屏幕时面板自动隐藏
- **快捷开关**: 顶部菜单栏显示🦴按钮，点击展开/收起
- **垂直布局**: 移动端控件垂直排列
- **触摸优化**: 按钮大小和间距适配触摸操作

### 移动端界面
```
┌─────────────────────┐
│ 🦴 🤖 AI虚拟人      │ ← 点击🦴打开面板
│ [提供商] [模型] [清空] │
└─────────────────────┘
```

---

## 🔧 技术实现

### 核心API
```javascript
// 获取骨骼列表
for (const name in vrm.humanoid.humanBones) {
  console.log(name);
}

// 控制单个骨骼
const boneNode = vrm.humanoid.getBoneNode(boneName);
boneNode.rotation.x = Math.PI / 6;  // 30度
boneNode.rotation.y = 0;
boneNode.rotation.z = 0;

// 重置骨骼
boneNode.rotation.set(0, 0, 0);
```

### 核心函数
- **rotateBone()** - 控制特定骨骼旋转
- **resetAllBones()** - 重置所有骨骼  
- **processBoneCommand()** - 解析聊天指令
- **generateRandomActions()** - 生成随机动作
- **executeActionSequence()** - 执行动作序列

### 中文映射系统
```javascript
const boneNameMap = {
    'head': '头部',
    'neck': '颈部',
    'leftUpperArm': '左上臂',
    'rightUpperArm': '右上臂',
    'leftThumbProximal': '左拇指近端',
    // ... 完整映射表
};
```

---

## 💡 使用技巧与最佳实践

### 角度参考
- **15°-30°** - 轻微动作 (点头、轻微转向)
- **45°-60°** - 中等动作 (明显转头、部分抬臂)  
- **75°-90°** - 明显动作 (大幅抬臂、深度弯腰)

### 操作建议
1. **从小角度开始**: 先用较小角度测试效果
2. **逐步调整**: 通过多次小幅调整达到理想效果
3. **合理组合**: 多个骨骼协调使用实现自然动作
4. **混合使用**: 聊天控制和面板控制可以结合使用

### 常用动作组合
- **问候动作**: 头部点头 + 右手挥手
- **展示动作**: 双臂展开 + 脊柱挺直
- **告别动作**: 左右转头 + 双手挥动

---

## ⚠️ 注意事项

### 系统要求
1. **VRM模型加载**: 确保VRM模型已完全加载
2. **浏览器兼容**: 建议使用现代浏览器
3. **Three-VRM版本**: 确认使用0.6.11版本

### 使用限制
- **角度范围**: 输入角度限制在 -180° 到 +180°
- **单次控制**: 每次只能控制一个骨骼的旋转
- **模型依赖**: 某些骨骼可能在特定模型中不可用

### 性能考虑
- **动作数量**: 建议每次动作序列不超过20个
- **执行间隔**: 系统自动添加800ms间隔确保流畅性
- **内存管理**: 大量动作可能需要适当的内存管理

---

## 🔍 问题诊断与解决

### 常见问题

#### 1. 功能不显示或显示异常
**原因**: 浏览器缓存问题
**解决**: 
- Windows: `Ctrl + F5` 或 `Ctrl + Shift + R`
- Mac: `Cmd + Shift + R`
- 开发者工具: Network → Disable cache

#### 2. 骨骼控制不生效
**原因**: VRM模型未加载完成或骨骼名称错误
**解决**:
- 检查VRM模型加载状态
- 确认骨骼名称与VRM规范一致
- 查看浏览器控制台错误信息

#### 3. 中文显示不完整
**原因**: 映射文件未正确加载
**解决**:
- 清除浏览器缓存
- 检查`boneNameMap`映射表
- 验证文件修改是否生效

#### 4. 动作不自然
**原因**: 旋转角度或骨骼层级问题
**解决**:
- 调整旋转角度到合理范围
- 修改动画持续时间
- 检查骨骼层级关系

### 诊断步骤
1. **检查模型加载**: `console.log(window.currentVRM)`
2. **验证骨骼可用**: `for (const name in vrm.humanoid.humanBones) { console.log(name); }`
3. **测试单个控制**: 使用面板单独控制每个骨骼
4. **检查控制台**: F12 查看错误信息和警告

---

## 🎉 扩展功能

### 可扩展方向
- **表情控制**: 结合眼部和面部骨骼
- **语音同步**: 根据语音输入同步动作
- **动作录制**: 记录和回放动作序列
- **物理模拟**: 添加重力和碰撞效果
- **AI生成**: 基于描述自动生成动作

### 开发建议
1. **模块化设计**: 保持各功能模块独立
2. **向下兼容**: 确保新功能不影响现有功能
3. **性能优化**: 注意动画性能和内存使用
4. **用户体验**: 保持界面简洁和操作直观

---

## 📚 总结

这是一个功能完整的虚拟人骨骼控制系统，提供了四种控制方式：

1. **🗣️ 聊天控制** - 自然语言，快速便捷
2. **🎮 面板控制** - 精确操作，直观反馈
3. **🎬 动作编排** - 复杂序列，创意无限
4. **🎲 随机生成** - 智能创作，趣味探索

系统采用固定布局设计，支持移动端适配，具备完整的中文本地化，为虚拟人交互提供了强大而灵活的控制能力。

---

🎊 **恭喜！你现在拥有了一个专业级的Three-VRM骨骼控制系统！**

让虚拟人展现无限可能，创造精彩的互动体验！ 